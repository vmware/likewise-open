#!/bin/sh

set -e

PATH=$PATH:/opt/likewise/bin
export PATH

case "$1" in
    abort-upgrade)
    ;;

    configure)
    domainjoin-cli configure --enable pam
    domainjoin-cli configure --enable nsswitch

    if [ -z "`pidof lwsmd`" ]; then
        /etc/init.d/lwsmd start
    else
        lwsm stop lwreg || true
        /etc/init.d/lwsmd restart
    fi

    echo -n "Waiting for lwreg startup."
    while( test -z "`/opt/likewise/bin/lwsm status lwreg | grep standalone:`" )
    do
        echo -n "."
        sleep 1
    done
    echo "ok"

    for file in /opt/likewise/share/config/*reg; do
	echo "Importing $file..."
        lwregshell upgrade $file > /dev/null
    done
    /etc/init.d/lwsmd reload
    lwsm stop lwreg
    lwsm start srvsvc
    ;;
esac

#DEBHELPER#
